"""
==========================================================================================
–ü–†–û–ï–ö–¢: –ú–ò–®–£–†–ê - –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–°—Ç–∏–ª–∏—Å—Ç
–ö–û–ú–ü–û–ù–ï–ù–¢: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gemini AI (gemini_ai.py)
–í–ï–†–°–ò–Ø: 0.3.1.4 (–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤)
–î–ê–¢–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø: 2025-05-20

–ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –†–ê–ë–û–¢–´ –ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–û–î–ê:
1.  –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –û–±–Ω–æ–≤–ª–µ–Ω–∏–π: –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º.
    –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
2.  –Ø–∑—ã–∫ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤–µ–¥—É—Ç—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
3.  –°—Ç–∞–Ω–¥–∞—Ä—Ç –ö–∞—á–µ—Å—Ç–≤–∞: –î–∞–Ω–Ω—ã–π –∫–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–æ–µ–∫—Ç–∞ "–ú–ò–®–£–†–ê", —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ
    —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤—ã—Å–æ—á–∞–π—à–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–∏–∑–∞–π–Ω–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—è
    —É—Ä–æ–≤–Ω—é –ª—É—á—à–∏—Ö –º–∏—Ä–æ–≤—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫.

–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –§–ê–ô–õ–ê:
–ú–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Google Gemini AI. –í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
–æ–¥–µ–∂–¥—ã –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
==========================================================================================
"""
import os
import logging
import time
import asyncio # –î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –∑–∞–¥–µ—Ä–∂–µ–∫
import google.generativeai as genai
from dotenv import load_dotenv
from PIL import Image, ImageOps, ImageDraw # ImageDraw –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
from io import BytesIO
from cache_manager import AnalysisCacheManager # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –µ—Å—Ç—å –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger_gemini = logging.getLogger(__name__)
if not logger_gemini.handlers: # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - [%(levelname)s] - %(name)s - [%(funcName)s:%(lineno)d] %(message)s'
    )

logger_gemini.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Gemini AI –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ú–ò–®–£–†–ê.")

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Gemini API
API_CONFIGURED_SUCCESSFULLY = False
if not GEMINI_API_KEY:
    logger_gemini.critical("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")
else:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        API_CONFIGURED_SUCCESSFULLY = True
        logger_gemini.info("Gemini API —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω.")
    except Exception as e:
        logger_gemini.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Gemini API: {e}", exc_info=True)

# –ú–æ–¥–µ–ª–∏ Gemini
VISION_MODEL = "models/gemini-1.5-flash"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
MAX_RETRIES = 3
RETRY_DELAY = 5 # –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫—ç—à–∞
CACHE_ENABLED = False # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫—ç—à –≤—ã–∫–ª—é—á–µ–Ω, –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
cache_manager = None
try:
    cache_manager = AnalysisCacheManager() # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ cache_manager.py
    CACHE_ENABLED = True
    logger_gemini.info("–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—ç—à–∞ AnalysisCacheManager —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
except ImportError:
    logger_gemini.warning("–ú–æ–¥—É–ª—å cache_manager.py –Ω–µ –Ω–∞–π–¥–µ–Ω. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –û–¢–ö–õ–Æ–ß–ï–ù–û.")
    class DummyCacheManager: # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∫—ç—à–∞
        def get_from_cache(self, *args, **kwargs): logger_gemini.debug("DummyCache: get_from_cache –≤—ã–∑–≤–∞–Ω."); return None
        def save_to_cache(self, *args, **kwargs): logger_gemini.debug("DummyCache: save_to_cache –≤—ã–∑–≤–∞–Ω.")
    cache_manager = DummyCacheManager()
except Exception as e_cache:
    logger_gemini.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AnalysisCacheManager: {e_cache}. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –û–¢–ö–õ–Æ–ß–ï–ù–û.", exc_info=True)
    if not isinstance(cache_manager, DummyCacheManager): # –ï—Å–ª–∏ –∑–∞–≥–ª—É—à–∫–∞ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
        class DummyCacheManagerOnError:
            def get_from_cache(self, *args, **kwargs): logger_gemini.debug("DummyCacheOnError: get_from_cache –≤—ã–∑–≤–∞–Ω."); return None
            def save_to_cache(self, *args, **kwargs): logger_gemini.debug("DummyCacheOnError: save_to_cache –≤—ã–∑–≤–∞–Ω.")
        cache_manager = DummyCacheManagerOnError()


async def test_gemini_connection():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API."""
    logger_gemini.debug("–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ test_gemini_connection.")
    if not API_CONFIGURED_SUCCESSFULLY:
        logger_gemini.error("–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: Gemini API –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω.")
        return False, "Gemini API –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç API –∫–ª—é—á –∏–ª–∏ –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)."
    try:
        model = genai.GenerativeModel(VISION_MODEL)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
        response = await model.generate_content_async("–≠—Ç–æ —Ç–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini API. –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ.")
        if response and response.text:
            logger_gemini.info(f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API ({VISION_MODEL}) —É—Å–ø–µ—à–Ω–æ. –û—Ç–≤–µ—Ç: {response.text[:50]}...")
            return True, f"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API ({VISION_MODEL}) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ."
        else:
            # –ê–Ω–∞–ª–∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ
            reason_message = "API –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç."
            if response and response.prompt_feedback and response.prompt_feedback.block_reason:
                reason_message += f" –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–º–ø—Ç–∞: {response.prompt_feedback.block_reason_message or response.prompt_feedback.block_reason}."
            elif response and response.candidates and not response.text:
                 if response.candidates[0].finish_reason:
                     reason_message += f" –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {response.candidates[0].finish_reason.name}."

            logger_gemini.error(f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –æ–∂–∏–¥–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç. {reason_message} –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç: {response}")
            return False, f"API –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å. {reason_message}"
    except Exception as e:
        logger_gemini.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å Gemini API: {e}", exc_info=True)
        return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini API: {str(e)}"

def handle_gemini_error(error: Exception, context_message: str = "") -> str:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç Gemini API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    logger_gemini.error(f"–û—à–∏–±–∫–∞ Gemini AI –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ '{context_message}': {type(error).__name__} - {error}", exc_info=True)
    error_str = str(error).lower()

    if "api key" in error_str or "authentication" in error_str or isinstance(error, (genai.types.PermissionDeniedError, genai.types.UnauthenticatedError)): # type: ignore
        return "–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å Gemini API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞."
    elif "content filtered" in error_str or "safety" in error_str or (hasattr(error, 'response') and hasattr(error.response, 'prompt_feedback') and error.response.prompt_feedback.block_reason): # type: ignore
        reason = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        if hasattr(error, 'response') and hasattr(error.response, 'prompt_feedback') and error.response.prompt_feedback.block_reason: # type: ignore
            reason = error.response.prompt_feedback.block_reason_message or error.response.prompt_feedback.block_reason # type: ignore
        return f"–ó–∞–ø—Ä–æ—Å –∫ Gemini API –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {reason}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞."
    elif isinstance(error, genai.types.ResourceExhaustedError): # type: ignore
        return "–ò—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini API. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–≤–æ—Ç—ã –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    elif isinstance(error, genai.types.DeadlineExceededError): # type: ignore
         return "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞."
    # –î—Ä—É–≥–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ Gemini –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å
    else:
        # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç–æ–º ({context_message}): {str(error)[:200]}"


def optimize_image(img_pil: Image.Image, max_size: int = 1024, quality: int = 85, format: str = 'JPEG') -> bytes:
    """
    –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ PIL.Image –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API.
    –ò–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ RGB (—É–¥–∞–ª—è—è –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª), –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∞–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç
    –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é JPEG) —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º.

    Args:
        img_pil: –û–±—ä–µ–∫—Ç PIL.Image.
        max_size: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–æ–ª—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
        quality: –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è JPEG (1-95).
        format: –§–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('JPEG', 'PNG').

    Returns:
        bytes: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    
    Raises:
        ValueError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
    """
    logger_gemini.debug(f"–ù–∞—á–∞–ª–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä {img_pil.size}, —Ä–µ–∂–∏–º {img_pil.mode}, —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç {format}")
    
    try:
        # 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ) —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        original_width, original_height = img_pil.size
        if original_width > max_size or original_height > max_size:
            if original_width > original_height:
                new_width = max_size
                new_height = int(original_height * (max_size / original_width))
            else:
                new_height = max_size
                new_width = int(original_width * (max_size / original_height))
            
            logger_gemini.info(f"–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å {original_width}x{original_height} –¥–æ {new_width}x{new_height}")
            img_pil = img_pil.resize((new_width, new_height), Image.Resampling.LANCZOS) # LANCZOS –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞

        # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ RGB (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª –∏–ª–∏ –Ω–µ RGB)
        # –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è JPEG –∏ —á–∞—Å—Ç–æ –¥–ª—è –º–æ–¥–µ–ª–µ–π –ò–ò, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ–∂–∏–¥–∞—é—Ç –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª
        if img_pil.mode in ('RGBA', 'LA') or (img_pil.mode == 'P' and 'transparency' in img_pil.info):
            logger_gemini.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∂–∏–º–∞ {img_pil.mode} –≤ RGB –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–∞.")
            # –°–æ–∑–¥–∞–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è –µ–≥–æ –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª –∫–∞–∫ –º–∞—Å–∫—É
            background = Image.new("RGB", img_pil.size, (255, 255, 255))
            img_rgba_for_paste = img_pil.convert("RGBA") # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º RGBA –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—Å–∫–µ
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∫ –º–∞—Å–∫—É
            alpha_mask = img_rgba_for_paste.split()[3] if len(img_rgba_for_paste.split()) == 4 else None
            background.paste(img_rgba_for_paste, mask=alpha_mask)
            img_pil = background
        elif img_pil.mode != 'RGB':
            logger_gemini.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∂–∏–º–∞ {img_pil.mode} –≤ RGB.")
            img_pil = img_pil.convert('RGB')
        
        logger_gemini.debug(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: —Ä–µ–∂–∏–º {img_pil.mode}, —Ä–∞–∑–º–µ—Ä {img_pil.size}.")

        # 3. –ê–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–µ—Ç–∫–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —á–∞—Å—Ç–æ –ø–æ–ª–µ–∑–Ω–æ)
        try:
            img_pil = ImageOps.autocontrast(img_pil, cutoff=0.5) # cutoff –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            logger_gemini.debug("–ê–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω.")
        except Exception as e_ac:
            logger_gemini.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç: {e_ac}. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ.")
        
        # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–π—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ –≤ —Ü–µ–ª–µ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        img_byte_arr = BytesIO()
        save_params = {'optimize': True}
        if format.upper() == 'JPEG':
            save_params['quality'] = quality
        
        img_pil.save(img_byte_arr, format=format.upper(), **save_params)
        img_bytes = img_byte_arr.getvalue()
        
        logger_gemini.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: —Ñ–æ—Ä–º–∞—Ç {format}, –∫–∞—á–µ—Å—Ç–≤–æ {quality if format.upper() == 'JPEG' else 'N/A'}, –∏—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: {len(img_bytes) / 1024:.1f} KB")
        return img_bytes
    
    except Exception as e:
        logger_gemini.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ —Ñ—É–Ω–∫—Ü–∏–∏ optimize_image: {type(e).__name__} - {e}", exc_info=True)
        # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ ValueError –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫ –æ—Ç —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {str(e)}")


def create_analysis_prompt(occasion: str, preferences: str = None) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Gemini AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ–¥–µ–∂–¥—ã."""
    logger_gemini.debug(f"–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–≤–æ–¥: '{occasion}', –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: '{preferences or '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}'")
    # (–í–∞—à —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π)
    prompt = f"""–¢—ã ‚Äî –ú–∏—à—É—Ä–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ–¥–µ–∂–¥—ã –Ω–∞ —Ñ–æ—Ç–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–ü–æ–≤–æ–¥/—Å–∏—Ç—É–∞—Ü–∏—è:** {occasion}
{f'- **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {preferences}' if preferences and preferences.strip() else '- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –Ω–µ —É–∫–∞–∑–∞–Ω—ã.'}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1.  **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—â—å:** –î–∞–π —á–µ—Ç–∫–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –Ω–∏–∂–µ. –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω, –Ω–æ –Ω–µ —É–ø—É—Å–∫–∞–π –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.
2.  **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ):** –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞, –µ—Å–ª–∏ —Ç—ã –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–¥–∏—à—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∫—É—Ä—Å–∞ —Ñ–æ—Ç–æ, —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É, –µ—Å–ª–∏ –æ–Ω —Å–æ–≤—Å–µ–º –Ω–µ —è—Å–µ–Ω, –∏–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö –ª–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è —Å–æ–≤–µ—Ç–∞ –ø–æ –¥–∞–Ω–Ω–æ–π –≤–µ—â–∏ –∏ –ø–æ–≤–æ–¥—É) –º–æ–≥–ª–æ –±—ã *–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ* —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–π —Å–æ–≤–µ—Ç –≤ *–±—É–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ*, –¥–æ–±–∞–≤—å —Ç–∞–∫—Ç–∏—á–Ω—É—é –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π".
    * **–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫:** "–ö—Å—Ç–∞—Ç–∏, –Ω–∞ —Ñ–æ—Ç–æ –Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞ —Ç–∫–∞–Ω–∏ –ø–∏–¥–∂–∞–∫–∞. –ï—Å–ª–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –∫—Ä—É–ø–Ω–µ–µ –∏–ª–∏ –ø—Ä–∏ –ª—É—á—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏, —è —Å–º–æ–≥—É —Ç–æ—á–Ω–µ–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫ –Ω–µ–º—É –±—Ä—é–∫–∏ –ø–æ —Ñ–∞–∫—Ç—É—Ä–µ.", "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –ø–ª–∞—Ç—å—è! –ß—Ç–æ–±—ã —è –º–æ–≥–ª–∞ –¥–∞–≤–∞—Ç—å –µ—â–µ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–∞—Å–æ–Ω–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç –≤–∞—à—É —Ñ–∏–≥—É—Ä—É, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã –º–æ–≥–ª–∏ –±—ã —É–ø–æ–º—è–Ω—É—Ç—å –≤–∞—à —Ä–æ—Å—Ç –∏ —Ç–∏–ø —Ñ–∏–≥—É—Ä—ã, –µ—Å–ª–∏ –≤–∞–º –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ."
    * **–ö–æ–≥–¥–∞ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É:** –ù–µ –¥–æ–±–∞–≤–ª—è–π —ç—Ç—É —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Å–æ–≤–µ—Ç–∞, –∏–ª–∏ –µ—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –±—É–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –æ–±—â–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"), –∏–ª–∏ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –¢–≤–æ—è —Ü–µ–ª—å ‚Äì –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∞ –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –ø—Ä–∏–¥–∏—Ä—á–∏–≤–æ–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (Markdown):

### 1. –û–ø–∏—Å–∞–Ω–∏–µ –í–µ—â–∏ (–ú–∏—à—É—Ä–∞)
* **–¢–∏–ø:** (–Ω–∞–ø—Ä., –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –±–ª—É–∑–∫–∞, –ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–∂–∏–Ω—Å—ã, –í–µ—á–µ—Ä–Ω–µ–µ –ø–∞–ª—å—Ç–æ)
* **–§–∞—Å–æ–Ω –∏ –∫—Ä–æ–π:** (–Ω–∞–ø—Ä., –ü–æ–ª—É–ø—Ä–∏–ª–µ–≥–∞—é—â–∏–π —Å–∏–ª—É—ç—Ç, –ü—Ä—è–º–æ–π –∫—Ä–æ–π —Å–æ —Å—Ç—Ä–µ–ª–∫–∞–º–∏, –û–≤–µ—Ä—Å–∞–π–∑ —Å –æ–±—ä–µ–º–Ω—ã–º–∏ —Ä—É–∫–∞–≤–∞–º–∏)
* **–¶–≤–µ—Ç/–ü—Ä–∏–Ω—Ç:** (–Ω–∞–ø—Ä., –ì–ª—É–±–æ–∫–∏–π –∏–∑—É–º—Ä—É–¥–Ω—ã–π, –î–µ–ª–∏–∫–∞—Ç–Ω—ã–π —Ü–≤–µ—Ç–æ—á–Ω—ã–π –ø—Ä–∏–Ω—Ç –Ω–∞ –∫—Ä–µ–º–æ–≤–æ–º —Ñ–æ–Ω–µ)
* **–ú–∞—Ç–µ—Ä–∏–∞–ª (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ):** (–Ω–∞–ø—Ä., –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —à–µ–ª–∫, –ü–ª–æ—Ç–Ω—ã–π —Ö–ª–æ–ø–æ–∫, –°–º–µ—Å–æ–≤–∞—è —à–µ—Ä—Å—Ç—å). *–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω, —É–∫–∞–∂–∏: "–ü–æ —Ñ–æ—Ç–æ —Å–ª–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª, –Ω–æ —Ç–∞–∫—Ç–∏–ª—å–Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å..."*
* **–ö–ª—é—á–µ–≤—ã–µ –¥–µ—Ç–∞–ª–∏:** (–Ω–∞–ø—Ä., –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π –≤–æ—Ä–æ—Ç–Ω–∏–∫, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –æ—Ç—Å—Ç—Ä–æ—á–∫–∞, –¥—Ä–∞–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ç–∞–ª–∏–∏)

### 2. –û—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–≤–æ–¥–∞ "{occasion}" –æ—Ç –ú–∏—à—É—Ä—ã
* **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** (–Ω–∞–ø—Ä., –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! / –û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç / –¢—Ä–µ–±—É–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ / –ù–µ —Å–∞–º—ã–π —É–¥–∞—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å...)
* **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞, –∏ –∫–∞–∫ –º–æ–∂–Ω–æ –Ω–∞–∏–ª—É—á—à–∏–º –æ–±—Ä–∞–∑–æ–º —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–≤–æ–¥–∞)

### 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –°–æ—á–µ—Ç–∞–Ω–∏—è–º –æ—Ç –ú–∏—à—É—Ä—ã (1-2 —Å–∞–º—ã—Ö —É–¥–∞—á–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞)
* **–û–±—Ä–∞–∑ 1:** (–° —á–µ–º —Å–æ—á–µ—Ç–∞—Ç—å: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–µ—Ä—Ö/–Ω–∏–∑, –æ–±—É–≤—å. –ü—Ä–∏–º–µ—Ä: "–≠—Ç–∞ —é–±–∫–∞ –±—É–¥–µ—Ç –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å—Å—è —Å –æ–±–ª–µ–≥–∞—é—â–∏–º –∫–∞—à–µ–º–∏—Ä–æ–≤—ã–º –¥–∂–µ–º–ø–µ—Ä–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –≤—ã—Å–æ–∫–∏–º–∏ —Å–∞–ø–æ–≥–∞–º–∏ –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ–º –∫–∞–±–ª—É–∫–µ –≤ —Ç–æ–Ω —é–±–∫–∏.")
* **–û–±—Ä–∞–∑ 2 (–µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ä–æ—à–∏–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç):** (–ü—Ä–∏–º–µ—Ä: "–î–ª—è –±–æ–ª–µ–µ —Å–º–µ–ª–æ–≥–æ –æ–±—Ä–∞–∑–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –µ–µ —Å –≥—Ä–∞—Ñ–∏—á–Ω–æ–π —Ñ—É—Ç–±–æ–ª–∫–æ–π, –∫–æ–∂–∞–Ω–æ–π –∫–æ—Å—É—Ö–æ–π –∏ –≥—Ä—É–±—ã–º–∏ –±–æ—Ç–∏–Ω–∫–∞–º–∏.")
* **–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã (1-2 –∫–ª—é—á–µ–≤—ã—Ö):** (–ü—Ä–∏–º–µ—Ä: "–ò–∑ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å—é–¥–∞ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–æ–ª–æ—Ç—ã–µ —Å–µ—Ä—å–≥–∏.")

### 4. –û–±—â–µ–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –∏ –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –æ—Ç –ú–∏—à—É—Ä—ã (–∫—Ä–∞—Ç–∫–æ)
* (–ü—Ä–∏–º–µ—Ä: "–û—á–µ–Ω—å —Å—Ç–∏–ª—å–Ω–∞—è –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—â—å, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–æ–π –º–Ω–æ–≥–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ–π –æ—Å–µ–Ω–∏ –∏ –≤–µ—Å–Ω—ã.")

---
(–ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ï—Å–ª–∏ –ú–∏—à—É—Ä–∞ —Ä–µ—à–∏–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å, –Ω–∞—á–∏–Ω–∞—è —Å "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π:")
"""
    return prompt

def create_comparison_prompt(occasion: str, preferences: str = None) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Gemini AI –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –æ–¥–µ–∂–¥—ã."""
    logger_gemini.debug(f"–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –ü–æ–≤–æ–¥: '{occasion}', –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: '{preferences or '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}'")
    # (–í–∞—à —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π)
    prompt = f"""–¢—ã ‚Äî –ú–∏—à—É—Ä–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç. –¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ñ–æ—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –æ–¥–µ–∂–¥—ã. –ü—Ä–æ–≤–µ–¥–∏ –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ –µ–º–∫–∏–π —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é, –∫–∞–∫–æ–π –∏–∑ –Ω–∏—Ö –ª—É—á—à–µ.

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–ü–æ–≤–æ–¥/—Å–∏—Ç—É–∞—Ü–∏—è:** {occasion}
{f'- **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {preferences}' if preferences and preferences.strip() else '- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –Ω–µ —É–∫–∞–∑–∞–Ω—ã.'}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1.  **–°—Ä–∞–≤–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç—ã:** –û—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –∫–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç (1-2 –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏). –ó–∞—Ç–µ–º —Å—Ä–∞–≤–Ω–∏ –∏—Ö –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–≤–æ–¥—É –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º.
2.  **–î–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é:** –ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –ª—É—á—à–∏–º –≤—ã–±–æ—Ä–æ–º –∏ –ø–æ—á–µ–º—É (1-2 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞).
3.  **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ):** –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞, –µ—Å–ª–∏ —Ç—ã –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–¥–∏—à—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã—Ö –≤–µ—â–∞—Ö –∏–ª–∏ –æ –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–≥–ª–æ –±—ã *–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ* —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–π —Å–æ–≤–µ—Ç –≤ *–±—É–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ*, –¥–æ–±–∞–≤—å —Ç–∞–∫—Ç–∏—á–Ω—É—é –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π".
    * **–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫:** "–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑, –µ—Å–ª–∏ –±—É–¥–µ—Ç–µ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –ø–ª–∞—Ç—å—è, —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç –ø–æ–º–æ–≥—É—Ç –º–Ω–µ –ª—É—á—à–µ –æ—Ü–µ–Ω–∏—Ç—å, –∫–∞–∫ –æ–Ω–∏ —Å–∏–¥—è—Ç –ø–æ —Ñ–∏–≥—É—Ä–µ.", "–ü–æ—Å–∫–æ–ª—å–∫—É –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∫–∞–∂—É—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–º–∏, —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –∫–∞–∫–æ–π —Å—Ç–∏–ª—å (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –∏–ª–∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π) –≤–∞–º –±–ª–∏–∂–µ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –ø–æ–º–æ–≥–ª–æ –±—ã –º–Ω–µ –¥–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é."
    * **–ö–æ–≥–¥–∞ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É:** –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –±—É–¥–µ—Ç –æ–±—â–µ–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (Markdown):

### –ö—Ä–∞—Ç–∫–∏–π –û–±–∑–æ—Ä –ü—Ä–µ–¥–º–µ—Ç–æ–≤ –æ—Ç –ú–∏—à—É—Ä—ã
(–ù—É–º–µ—Ä—É–π –ø—Ä–µ–¥–º–µ—Ç—ã –∫–∞–∫ "–ü—Ä–µ–¥–º–µ—Ç 1", "–ü—Ä–µ–¥–º–µ—Ç 2" –∏ —Ç.–¥.)
* **–ü—Ä–µ–¥–º–µ—Ç 1:** (–Ω–∞–ø—Ä., –ß–µ—Ä–Ω–æ–µ –ø–ª–∞—Ç—å–µ-—Ñ—É—Ç–ª—è—Ä –∏–∑ –ø–ª–æ—Ç–Ω–æ–≥–æ —Ç—Ä–∏–∫–æ—Ç–∞–∂–∞)
* **–ü—Ä–µ–¥–º–µ—Ç 2:** (–Ω–∞–ø—Ä., –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π –±—Ä—é—á–Ω—ã–π –∫–æ—Å—Ç—é–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∫—Ä–æ—è)
    (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤–æ–¥–∞ "{occasion}" –æ—Ç –ú–∏—à—É—Ä—ã
(–û—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ, –ø–æ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç: –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–≤–æ–¥–∞)
* **–ü—Ä–µ–¥–º–µ—Ç 1:** (–Ω–∞–ø—Ä., –í—ã–≥–ª—è–¥–∏—Ç –±–æ–ª–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏ —Å—Ç—Ä–æ–≥–æ, —á—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –¥–µ–ª–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏.)
* **–ü—Ä–µ–¥–º–µ—Ç 2:** (–Ω–∞–ø—Ä., –°–æ–∑–¥–∞–µ—Ç –±–æ–ª–µ–µ —è—Ä–∫–∏–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π—Å—è –æ–±—Ä–∞–∑, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —É–º–µ—Å—Ç–µ–Ω –≤ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ.)
    (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)

### –ò—Ç–æ–≥–æ–≤–∞—è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç –ú–∏—à—É—Ä—ã
* **–õ—É—á—à–∏–π –≤—ã–±–æ—Ä:** –ü—Ä–µ–¥–º–µ—Ç [–ù–æ–º–µ—Ä] - –ø–æ—Ç–æ–º—É —á—Ç–æ [1-2 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞, –ø–æ—á–µ–º—É –æ–Ω –ª—É—á—à–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–≤–æ–¥–∞, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å].
* **–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ª—É—á—à–µ–≥–æ –≤—ã–±–æ—Ä–∞ (1 —Å–æ–≤–µ—Ç):** (–Ω–∞–ø—Ä., "–î–æ–ø–æ–ª–Ω–∏—Ç–µ –ü—Ä–µ–¥–º–µ—Ç X –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º–∏ –ª–æ–¥–æ—á–∫–∞–º–∏ –∏ –Ω–µ–±–æ–ª—å—à–æ–π —Å—É–º–∫–æ–π-—Ç–æ—É—Ç.")

---
(–ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ï—Å–ª–∏ –ú–∏—à—É—Ä–∞ —Ä–µ—à–∏–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å, –Ω–∞—á–∏–Ω–∞—è —Å "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π:")
"""
    return prompt

async def _send_to_gemini_with_retries(parts: list, context_for_log: str) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Gemini API —Å –ª–æ–≥–∏–∫–æ–π –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
    logger_gemini.debug(f"–ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini: –∫–æ–Ω—Ç–µ–∫—Å—Ç '{context_for_log}', –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–µ–π: {len(parts)}")
    if not API_CONFIGURED_SUCCESSFULLY:
        msg = f"Gemini API –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø—Ä–æ—Å –¥–ª—è '{context_for_log}' –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."
        logger_gemini.error(msg)
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_INTERNAL_ERROR_ID_G01"), context_for_log)

    retry_count = 0
    last_exception: Exception | None = None
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –∏—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
    generation_config = genai.types.GenerationConfig(
        temperature=0.65, # –£–º–µ—Ä–µ–Ω–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
        # top_p=0.95, # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        # top_k=40,   # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        # max_output_tokens=2048 # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    )
    safety_settings = [ # –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ä–µ–¥–Ω–µ–π –∏ –≤—ã—Å–æ–∫–æ–π —Å—Ç–µ–ø–µ–Ω–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        {"category": c, "threshold": "BLOCK_MEDIUM_AND_ABOVE"}
        for c in [
            "HARM_CATEGORY_HARASSMENT", "HARM_CATEGORY_HATE_SPEECH",
            "HARM_CATEGORY_SEXUALLY_EXPLICIT", "HARM_CATEGORY_DANGEROUS_CONTENT"
        ]
    ]

    while retry_count < MAX_RETRIES:
        try:
            model = genai.GenerativeModel(VISION_MODEL) # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å
            logger_gemini.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}/{MAX_RETRIES}...")
            
            response = await model.generate_content_async(
                parts,
                generation_config=generation_config,
                safety_settings=safety_settings,
                # request_options={"timeout": 60} # –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            )
            
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ (Gemini 1.5 –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ-—Ä–∞–∑–Ω–æ–º—É)
            full_response_text = ""
            if hasattr(response, 'text') and response.text:
                full_response_text = response.text.strip()
            elif response.parts: # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —á–∞—Å—Ç–µ–π
                 full_response_text = "".join(part.text for part in response.parts if hasattr(part, 'text')).strip()

            if full_response_text: # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
                logger_gemini.info(f"–û—Ç–≤–µ—Ç –æ—Ç Gemini ({context_for_log}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}). –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(full_response_text)} —Å–∏–º–≤–æ–ª–æ–≤.")
                return full_response_text # –£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥
            else:
                # –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                finish_reason_str = "N/A"
                block_reason_str = "N/A"
                if response.candidates and len(response.candidates) > 0:
                    candidate = response.candidates[0]
                    if candidate.finish_reason:
                        finish_reason_str = candidate.finish_reason.name
                    # –î–ª—è Gemini 1.5 –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ prompt_feedback
                if response.prompt_feedback and response.prompt_feedback.block_reason:
                     block_reason_str = response.prompt_feedback.block_reason.name
                     finish_reason_str = f"PROMPT_BLOCKED ({block_reason_str})" # –£—Ç–æ—á–Ω—è–µ–º –ø—Ä–∏—á–∏–Ω—É

                logger_gemini.warning(f"–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {finish_reason_str}, –ø—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {block_reason_str}.")
                last_exception = ValueError(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {finish_reason_str}, –ø—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {block_reason_str}")
                setattr(last_exception, 'response', response) # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                
                # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–µ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º—ã—Ö –ø—Ä–∏—á–∏–Ω
                if finish_reason_str in ["SAFETY", "RECITATION", "MAX_TOKENS"] or "PROMPT_BLOCKED" in finish_reason_str:
                    logger_gemini.error(f"–ù–µ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini ({context_for_log}): {finish_reason_str}. –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫.")
                    return handle_gemini_error(last_exception, context_for_log)
                # –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–∏—á–∏–Ω –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UNKNOWN, OTHER) - –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑

        except Exception as e:
            last_exception = e
            logger_gemini.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}/{MAX_RETRIES}: {type(e).__name__} - {e}", exc_info=False) # exc_info=False —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π traceback –æ—Ç handle_gemini_error
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–¥–æ—Å—Ç—É–ø–∞
            if isinstance(e, (genai.types.PermissionDeniedError, genai.types.UnauthenticatedError)): # type: ignore
                logger_gemini.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–¥–æ—Å—Ç—É–ø–∞ –∫ Gemini API ({context_for_log}). –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫.")
                return handle_gemini_error(e, context_for_log)

        retry_count += 1
        if retry_count < MAX_RETRIES:
            logger_gemini.info(f"–û–∂–∏–¥–∞–Ω–∏–µ {RETRY_DELAY} —Å–µ–∫. –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π ({context_for_log})...")
            await asyncio.sleep(RETRY_DELAY) # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

    # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
    final_error_message = f"–í—Å–µ {MAX_RETRIES} –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ ({context_for_log}) –∫ Gemini –Ω–µ —É–¥–∞–ª–∏—Å—å."
    logger_gemini.error(final_error_message, exc_info=True if last_exception else False)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º last_exception, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ, –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –æ–±—â–µ–µ
    error_to_handle = last_exception or ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ (–∫–æ–¥: G-RETRY01).")
    return handle_gemini_error(error_to_handle, context_for_log)


async def analyze_clothing_image(image_data: bytes, occasion: str, preferences: str = None) -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–µ–∂–¥—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Gemini AI."""
    context = "–∞–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    logger_gemini.info(f"–ù–∞—á–∞–ª–æ {context}: –ø–æ–≤–æ–¥ '{occasion}', —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö {len(image_data)/1024:.1f} KB.")
    
    if not API_CONFIGURED_SUCCESSFULLY:
        return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_ANALYZE_ID_G02"), context)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –∏ –º–µ–Ω–µ–¥–∂–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω)
    if CACHE_ENABLED and cache_manager:
        cached_result = cache_manager.get_from_cache(image_data, occasion, preferences)
        if cached_result:
            logger_gemini.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {context} —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –∫—ç—à–∞.")
            return cached_result
    
    try:
        pil_image = Image.open(BytesIO(image_data))
        optimized_image_bytes = optimize_image(pil_image, quality=85, format='JPEG') # JPEG –æ–±—ã—á–Ω–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –¥–ª—è Gemini Vision
    except ValueError as ve: # –û—à–∏–±–∫–∞ –æ—Ç optimize_image
        logger_gemini.error(f"–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è {context}: {ve}", exc_info=True)
        return str(ve) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    except Exception as e_opt: # –î—Ä—É–≥–∏–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        logger_gemini.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è {context}: {e_opt}", exc_info=True)
        return "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–∫–æ–¥: G-OPT01)."

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –∏ —á–∞—Å—Ç–µ–π –∑–∞–ø—Ä–æ—Å–∞
    prompt = create_analysis_prompt(occasion, preferences)
    # Gemini Vision API –æ–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    # mime_type –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É optimized_image_bytes
    parts = [prompt, {"mime_type": "image/jpeg", "data": optimized_image_bytes}] 
    
    response_text = await _send_to_gemini_with_retries(parts, context)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à (–µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏ –Ω–µ –æ—à–∏–±–∫–∞)
    if CACHE_ENABLED and cache_manager and not _is_error_message(response_text):
        try:
            cache_manager.save_to_cache(image_data, occasion, response_text, preferences) # –ö—ç—à–∏—Ä—É–µ–º –ø–æ –∏—Å—Ö–æ–¥–Ω—ã–º –±–∞–π—Ç–∞–º
            logger_gemini.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {context} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫—ç—à.")
        except Exception as e_save_cache:
            logger_gemini.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –∫—ç—à –¥–ª—è {context}: {e_save_cache}", exc_info=True)
            
    return response_text


async def compare_clothing_images(image_data_list: list[bytes], occasion: str, preferences: str = None) -> str:
    """–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–¥–µ–∂–¥—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Gemini AI."""
    context = "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
    logger_gemini.info(f"–ù–∞—á–∞–ª–æ {context}: {len(image_data_list)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–æ–≤–æ–¥ '{occasion}'.")

    if not API_CONFIGURED_SUCCESSFULLY:
        return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_COMPARE_ID_G03"), context)
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if not (2 <= len(image_data_list) <= 5): # Gemini –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ, –Ω–æ –¥–ª—è –¢–ó –ø–æ–∫–∞ —Ç–∞–∫
        msg = f"–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç 2 –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–æ–ª—É—á–µ–Ω–æ: {len(image_data_list)}."
        logger_gemini.warning(msg)
        return msg # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–±—ã—á–Ω–æ —Å–ª–æ–∂–Ω–µ–µ –∏ —Ä–µ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è,
    # —Ç–∞–∫ –∫–∞–∫ –ø–æ—Ä—è–¥–æ–∫ –∏ –Ω–∞–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–∞–∂–Ω—ã. –ü–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º.
    # if CACHE_ENABLED and cache_manager: logger_gemini.debug(f"{context}: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.")

    processed_parts = [create_comparison_prompt(occasion, preferences)]
    for i, img_data_bytes in enumerate(image_data_list):
        logger_gemini.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1}/{len(image_data_list)} –¥–ª—è {context} (—Ä–∞–∑–º–µ—Ä: {len(img_data_bytes)/1024:.1f} KB).")
        try:
            pil_image = Image.open(BytesIO(img_data_bytes))
            optimized_bytes = optimize_image(pil_image, quality=85, format='JPEG')
            # –î–ª—è –º–Ω–æ–≥–æ–º–æ–¥–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏, –∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å
            processed_parts.append({"mime_type": "image/jpeg", "data": optimized_bytes})
        except ValueError as ve: # –û—à–∏–±–∫–∞ –æ—Ç optimize_image
            logger_gemini.error(f"–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1} –¥–ª—è {context}: {ve}", exc_info=True)
            return str(ve)
        except Exception as e_opt:
            logger_gemini.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1} –¥–ª—è {context}: {e_opt}", exc_info=True)
            return f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i+1} –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–∫–æ–¥: G-OPT02)."
            
    return await _send_to_gemini_with_retries(processed_parts, context)

def _is_error_message(text: str) -> bool:
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ."""
    if not text: return True # –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–æ–π –¥–ª—è —Ü–µ–ª–µ–π –Ω–µ–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –æ—à–∏–±–∫—É (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    error_keywords = [
        "–æ—à–∏–±–∫–∞", "–Ω–µ –Ω–∞–π–¥–µ–Ω", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π", "–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª",
        "–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "–ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç–µ–≤—ã–º", "–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞",
        "(–∫–æ–¥: g-", "–Ω–µ —É–¥–∞–ª–æ—Å—å", "–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏", "–ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤", "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
        "api_not_configured" # –∏–∑ –Ω–∞—à–∏—Ö RuntimeErrors
    ]
    text_lower = text.lower()
    return any(keyword in text_lower for keyword in error_keywords)


async def analyze_clothing_file(file_path: str, occasion: str, preferences: str = None) -> str:
    """
    –ß–∏—Ç–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ.
    –≠—Ç–æ –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ analyze_clothing_image –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –Ω–∞ –¥–∏—Å–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–æ—Ç–µ).
    """
    context = "–∞–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞"
    logger_gemini.info(f"–ù–∞—á–∞–ª–æ {context}: —Ñ–∞–π–ª '{file_path}', –ø–æ–≤–æ–¥ '{occasion}'.")
    
    if not os.path.exists(file_path) or not os.path.isfile(file_path):
        err_msg = f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏: {file_path}"
        logger_gemini.error(err_msg)
        return f"–û—à–∏–±–∫–∞: {err_msg}"
    
    try:
        with open(file_path, "rb") as image_file:
            image_data = image_file.read()
        if not image_data:
            err_msg = f"–§–∞–π–ª '{file_path}' –ø—É—Å—Ç–æ–π."
            logger_gemini.error(err_msg)
            return f"–û—à–∏–±–∫–∞: {err_msg}"
    except Exception as e:
        logger_gemini.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ '{file_path}': {e}", exc_info=True)
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {str(e)}"
        
    return await analyze_clothing_image(image_data, occasion, preferences)


# –¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è
if __name__ == "__main__":
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    if logger_gemini.level > logging.DEBUG: # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ DEBUG
      for handler in logger_gemini.handlers or logging.getLogger().handlers: # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∫–æ—Ä–Ω–µ–≤–æ–π –ª–æ–≥–≥–µ—Ä
          handler.setLevel(logging.DEBUG)
      logger_gemini.setLevel(logging.DEBUG)
      logger_gemini.info("–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ DEBUG.")


    async def main_test():
        print(f"\n======================================================================")
        print(f" –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è Gemini AI –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ú–ò–®–£–†–ê (v{getattr(gemini_ai, '__version__', '0.3.1.4')}) ")
        print(f" –ö—ç—à: {'–í–ö–õ–Æ–ß–ï–ù' if CACHE_ENABLED and cache_manager else '–û–¢–ö–õ–Æ–ß–ï–ù'}")
        print(f"======================================================================\n")

        if not API_CONFIGURED_SUCCESSFULLY:
            print("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Gemini API –Ω–µ –±—ã–ª —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.\n   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å GEMINI_API_KEY –≤ .env —Ñ–∞–π–ª–µ.")
            return

        print("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini API...")
        connected, msg = await test_gemini_connection()
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {'‚úÖ –£–°–ü–ï–®–ù–û' if connected else '‚ùå –û–®–ò–ë–ö–ê'} - {msg}\n")
        if not connected:
            return

        # --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
        # (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–Ω–æ–≥–æ —Ä–∞–∑)
        _test_image_cache = {}
        def get_test_image_bytes(
            image_id: str, text_on_img: str, rgb_color: tuple = (100, 100, 200),
            size: tuple = (400, 500), quality: int = 75, img_format: str = 'JPEG'
        ) -> bytes:
            cache_key = f"{image_id}_{rgb_color}_{size}_{quality}_{img_format}"
            if cache_key in _test_image_cache:
                logger_gemini.debug(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {cache_key}")
                return _test_image_cache[cache_key]

            logger_gemini.debug(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: id='{image_id}', —Ç–µ–∫—Å—Ç='{text_on_img}'")
            img = Image.new('RGB', size, color=rgb_color)
            draw = ImageDraw.Draw(img)
            try:
                # –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —à—Ä–∏—Ñ—Ç–æ–≤ .ttf
                # –î–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å ImageFont.truetype, –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç —Ç–µ—Å—Ç
                text_lines = text_on_img.split('\n')
                current_h = size[1] * 0.3
                for line in text_lines:
                    # text_width, text_height = draw.textsize(line) # –£—Å—Ç–∞—Ä–µ–ª–æ
                    bbox = draw.textbbox((0,0), line) # x0,y0,x1,y1
                    text_width = bbox[2] - bbox[0]
                    # text_height = bbox[3] - bbox[1] # –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–¥–µ—Å—å
                    
                    x = (size[0] - text_width) / 2
                    draw.text((x, current_h), line, fill=(255,255,255) if sum(rgb_color) < 384 else (0,0,0)) # –ë–µ–ª—ã–π –∏–ª–∏ —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                    current_h += 30 # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            except Exception as font_e:
                logger_gemini.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ '{image_id}': {font_e}. –¢–µ–∫—Å—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.")

            # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
            try:
                img_bytes = optimize_image(img, max_size=max(size), quality=quality, format=img_format)
                _test_image_cache[cache_key] = img_bytes
                logger_gemini.debug(f"–¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ '{image_id}' —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, {len(img_bytes)/1024:.1f} KB.")
                return img_bytes
            except ValueError as ve:
                logger_gemini.error(f"–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è '{image_id}': {ve}")
                return b'' # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –±–∞–π—Ç—ã –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏


        # --- –¢–µ—Å—Ç 1: –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
        print("\n--- –¢–µ—Å—Ç 1: –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–°–∏–Ω—è—è –§—É—Ç–±–æ–ª–∫–∞) ---")
        blue_shirt_bytes = get_test_image_bytes("blue_shirt", "–°–∏–Ω—è—è\n–§—É—Ç–±–æ–ª–∫–∞", rgb_color=(50, 80, 180))
        if blue_shirt_bytes:
            advice_single = await analyze_clothing_image(
                blue_shirt_bytes,
                occasion="–ø—Ä–æ–≥—É–ª–∫–∞ –≤ –ø–∞—Ä–∫–µ",
                preferences="–ª—é–±–ª—é –∫–æ–º—Ñ–æ—Ä—Ç, –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞"
            )
            print("\n–û—Ç–≤–µ—Ç –ú–∏—à—É—Ä—ã (–æ–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑):\n------------------------------------")
            print(advice_single)
            print("------------------------------------\n")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.")

        # --- –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
        print("\n--- –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–ó–µ–ª–µ–Ω—ã–µ –®–æ—Ä—Ç—ã vs –ö—Ä–∞—Å–Ω–∞—è –Æ–±–∫–∞) ---")
        green_shorts_bytes = get_test_image_bytes("green_shorts", "–ó–µ–ª–µ–Ω—ã–µ\n–®–æ—Ä—Ç—ã", rgb_color=(80, 150, 50))
        red_skirt_bytes = get_test_image_bytes("red_skirt", "–ö—Ä–∞—Å–Ω–∞—è\n–Æ–±–∫–∞", rgb_color=(200, 40, 40))
        
        if green_shorts_bytes and red_skirt_bytes:
            advice_compare = await compare_clothing_images(
                [green_shorts_bytes, red_skirt_bytes],
                occasion="–ª–µ—Ç–Ω–∏–π –ø–∏–∫–Ω–∏–∫",
                preferences="—É–¥–æ–±—Å—Ç–≤–æ –∏ —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞"
            )
            print("\n–û—Ç–≤–µ—Ç –ú–∏—à—É—Ä—ã (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ):\n---------------------------")
            print(advice_compare)
            print("---------------------------\n")
        else:
             print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.")

        # --- –¢–µ—Å—Ç 3: –û—à–∏–±–∫–∞ - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è ---
        print("\n--- –¢–µ—Å—Ç 3: –û—à–∏–±–∫–∞ - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---")
        images_for_fail_test = [
            get_test_image_bytes(f"img{i}", f"Image {i+1}", rgb_color=(i*30, 100, 200-i*20)) for i in range(6)
        ]
        if all(images_for_fail_test): # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
            advice_too_many = await compare_clothing_images(
                images_for_fail_test,
                occasion="–ª—é–±–æ–π",
            )
            print("\n–û—Ç–≤–µ—Ç –ú–∏—à—É—Ä—ã (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π):\n--------------------------------------")
            print(advice_too_many)
            print("--------------------------------------\n")
            if "–æ—Ç 2 –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π" in advice_too_many:
                print("‚úÖ –¢–µ—Å—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–π–¥–µ–Ω.")
            else:
                print("‚ö†Ô∏è –¢–µ—Å—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ù–ï –ø—Ä–æ–π–¥–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.")

        # --- –¢–µ—Å—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑) ---
        if CACHE_ENABLED and cache_manager and blue_shirt_bytes:
            print("\n--- –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –°–∏–Ω–µ–π –§—É—Ç–±–æ–ª–∫–∏) ---")
            # –û—á–∏—â–∞–µ–º –ª–æ–≥–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞
            # (–≠—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø–æ–π–¥–µ—Ç)
            # print("\n(–û–∂–∏–¥–∞–π—Ç–µ –º–µ–Ω—å—à–µ –ª–æ–≥–æ–≤ –æ—Ç Gemini, –µ—Å–ª–∏ –∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç)\n")
            start_time = time.time()
            advice_single_cached = await analyze_clothing_image(
                blue_shirt_bytes, # –¢–æ –∂–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                occasion="–ø—Ä–æ–≥—É–ª–∫–∞ –≤ –ø–∞—Ä–∫–µ", # –¢–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                preferences="–ª—é–±–ª—é –∫–æ–º—Ñ–æ—Ä—Ç, –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞"
            )
            end_time = time.time()
            print(f"   –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {end_time - start_time:.4f} —Å–µ–∫.")
            if advice_single_cached == advice_single:
                print("‚úÖ –û—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º.")
            else:
                print("‚ùå –û–®–ò–ë–ö–ê –ö–≠–®–ê: –û—Ç–≤–µ—Ç –∏–∑ –∫—ç—à–∞ –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º!")
            # –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç ... —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ –∫—ç—à–∞."
            # –ß—Ç–æ–±—ã —ç—Ç–æ —É–≤–∏–¥–µ—Ç—å, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ stdout/stderr, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ print.
        else:
            print("\n--- –¢–µ—Å—Ç 4: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –û–¢–ö–õ–Æ–ß–ï–ù–û –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, —Ç–µ—Å—Ç –ø—Ä–æ–ø—É—â–µ–Ω ---")
            
        print("\n======================================================================")
        print(" –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è Gemini AI –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
        print("======================================================================\n")

    # –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ main_test
    try:
        asyncio.run(main_test())
    except Exception as e_main_test:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è main_test(): {e_main_test}")
        import traceback
        traceback.print_exc()

# –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏ –º–æ–¥—É–ª—è, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
__version__ = "0.3.1.4"