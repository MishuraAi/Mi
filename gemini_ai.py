"""
–ü–†–û–ï–ö–¢: –ú–ò–®–£–†–ê - –ò–ò –°–¢–ò–õ–ò–°–¢
–ú–û–î–£–õ–¨: Gemini AI Integration
–í–ï–†–°–ò–Ø: 0.3.1.1 (–ù–∞ –±–∞–∑–µ –≤–∞—à–µ–π 0.3.1. –ü—Ä–æ–º–ø—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞)
–§–ê–ô–õ: gemini_ai.py
–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ú–æ–¥—É–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–µ–∂–¥—ã –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Gemini AI.
–î–ê–¢–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø: 2025-05-18

–ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–û–î–ê:
–§–∞–π–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –í–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ create_analysis_prompt –∏ create_comparison_prompt
–¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –æ—Ç –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç–∞ "–ú–∏—à—É—Ä–∞".
–û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–∞–π–ª–∞ (–≤–µ—Ä—Å–∏–∏ 0.3.1, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º) —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.
"""

import os
import logging
# import base64 # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ 0.3.1
import time # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è RETRY_DELAY
import google.generativeai as genai
from dotenv import load_dotenv
from PIL import Image, ImageOps
from io import BytesIO
from cache_manager import AnalysisCacheManager # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –µ—Å—Ç—å –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s - %(name)s - %(levelname)s - [%(funcName)s:%(lineno)d] %(message)s')
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Gemini API (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è)
API_CONFIGURED_SUCCESSFULLY = False
if not GEMINI_API_KEY:
    logger.critical("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
else:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        API_CONFIGURED_SUCCESSFULLY = True
        logger.info("Gemini API —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è.")
        # –£–±–∏—Ä–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç—Å—é–¥–∞, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–π –≤—ã–∑–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–º–ø–æ—Ä—Ç–µ.
        # –ï–≥–æ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–ª–∏ –≤ if __name__ == "__main__".
    except Exception as e:
        logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Gemini API: {e}", exc_info=True)


# –ü–æ–ª–Ω—ã–µ –∏–º–µ–Ω–∞ –º–æ–¥–µ–ª–µ–π (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "models/")
VISION_MODEL = "models/gemini-1.5-flash"  # –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
MAX_RETRIES = 3 # –ö–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1
# –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
RETRY_DELAY = 2 # –ö–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫—ç—à–∞
# –≠—Ç–æ—Ç –∫–æ–¥ –±—ã–ª –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1, –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ.
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ cache_manager.py –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.
try:
    cache_manager = AnalysisCacheManager()
    CACHE_ENABLED = True # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω, –∫—ç—à –≤–∫–ª—é—á–µ–Ω
    logger.info("–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—ç—à–∞ AnalysisCacheManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
except ImportError:
    CACHE_ENABLED = False
    logger.warning("cache_manager.py –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –û–¢–ö–õ–Æ–ß–ï–ù–û.")
    class DummyCacheManager:
        def get_from_cache(self, *args, **kwargs): logger.debug("DummyCache: get_from_cache called"); return None
        def save_to_cache(self, *args, **kwargs): logger.debug("DummyCache: save_to_cache called")
    cache_manager = DummyCacheManager()
except Exception as e_cache: # –õ–æ–≤–∏–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—ç—à–∞
    CACHE_ENABLED = False
    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AnalysisCacheManager: {e_cache}. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –û–¢–ö–õ–Æ–ß–ï–ù–û.", exc_info=True)
    class DummyCacheManager: # –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
        def get_from_cache(self, *args, **kwargs): logger.debug("DummyCache: get_from_cache called"); return None
        def save_to_cache(self, *args, **kwargs): logger.debug("DummyCache: save_to_cache called")
    cache_manager = DummyCacheManager()


# –§—É–Ω–∫—Ü–∏—è test_gemini_connection –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1 (–µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)
async def test_gemini_connection():
    logger.debug("–í—ã–∑–æ–≤ test_gemini_connection")
    if not API_CONFIGURED_SUCCESSFULLY:
        return False, "Gemini API –Ω–µ –±—ã–ª —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏."
    try:
        model = genai.GenerativeModel(VISION_MODEL) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
        response = await model.generate_content_async("Test connection to Gemini API") # –î–µ–ª–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
        if response and response.text:
            logger.info("–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ) —É—Å–ø–µ—à–Ω–æ.")
            return True, "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ."
        else:
            logger.error(f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gemini API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ —Ç–µ–∫—Å—Ç. –û—Ç–≤–µ—Ç: {response}")
            return False, "API –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å Gemini API: {e}", exc_info=True)
        return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini API: {str(e)}"

# –§—É–Ω–∫—Ü–∏—è handle_gemini_error –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1 (—Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏—è–º–∏ –¥–ª—è –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
def handle_gemini_error(error, context_message=""):
    # (–ö–æ–¥ –ø–æ—á—Ç–∏ –∫–∞–∫ –≤ 0.3.6, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∞—à–µ–π 0.3.1)
    logger.error(f"handle_gemini_error –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è ({context_message}). –û—à–∏–±–∫–∞: {type(error).__name__} - {error}", exc_info=True)
    error_str = str(error).lower()
    # ... (–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1,
    # –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥–∞–º–∏ –æ—à–∏–±–æ–∫ Gxx, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏—Ö —Ä–∞–∑–ª–∏—á–∞—Ç—å –≤ api.py)
    if "api key" in error_str or "authentication" in error_str:
        return "–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á."
    # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ, –∫–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1 ...
    elif "content filtered" in error_str or "safety" in error_str:
        return "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–∑-–∑–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
    else:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ({context_message}): {str(error)[:150]}" # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏


# –§—É–Ω–∫—Ü–∏—è optimize_image –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1 (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç PIL.Image, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç bytes)
# –î–æ–±–∞–≤–∏–º –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
def optimize_image(img: Image.Image, max_size=1024, quality=85) -> bytes:
    logger.debug(f"optimize_image: –°—Ç–∞—Ä—Ç. –í—Ö–æ–¥–Ω–æ–π PIL Image: —Ä–∞–∑–º–µ—Ä {img.size}, —Ä–µ–∂–∏–º {img.mode}")
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–∫–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1)
        original_width, original_height = img.size
        if original_width > max_size or original_height > max_size:
            if original_width > original_height:
                new_width = max_size
                new_height = int(original_height * (max_size / original_width))
            else:
                new_height = max_size
                new_width = int(original_width * (max_size / original_height))
            img = img.resize((new_width, new_height), Image.Resampling.LANCZOS) # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LANCZOS
            logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ —Å {original_width}x{original_height} –¥–æ {new_width}x{new_height}")

        # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ RGB (–∫–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1)
        if img.mode in ('RGBA', 'LA') or (img.mode == 'P' and 'transparency' in img.info):
            logger.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∂–∏–º–∞ {img.mode} –≤ RGB (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–∞).")
            # –°–æ–∑–¥–∞–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ñ–∞
            background = Image.new("RGB", img.size, (255, 255, 255))
            img_rgba_for_paste = img.convert("RGBA") # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º RGBA –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—Å–∫–µ
            background.paste(img_rgba_for_paste, mask=img_rgba_for_paste.split()[3] if len(img_rgba_for_paste.split()) == 4 else None)
            img = background
        elif img.mode != 'RGB': # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ RGB –∏ –Ω–µ —Å–ª—É—á–∞–π —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º –≤—ã—à–µ
            logger.info(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∂–∏–º–∞ {img.mode} –≤ RGB.")
            img = img.convert('RGB')
        
        logger.debug(f"–ü–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: —Ä–µ–∂–∏–º {img.mode}, —Ä–∞–∑–º–µ—Ä {img.size}.")

        # 3. –ê–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç (–∫–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1)
        try:
            img = ImageOps.autocontrast(img, cutoff=0.5) # cutoff –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        except Exception as e_ac:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç: {e_ac}. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ.")
        
        # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JPEG (–∫–∞–∫ –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1)
        img_byte_arr = BytesIO()
        img.save(img_byte_arr, format='JPEG', quality=quality, optimize=True)
        img_bytes = img_byte_arr.getvalue()
        
        logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: JPEG quality={quality}, –∏—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: {len(img_bytes) / 1024:.1f} KB")
        return img_bytes
    
    except Exception as e:
        logger.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ optimize_image: {type(e).__name__} - {e}", exc_info=True)
        raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {e}")


# === –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –ü–†–û–ú–ü–¢–´ ===
def create_analysis_prompt(occasion, preferences=None):
    logger.debug(f"–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–≤–æ–¥: {occasion}, –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {preferences}")
    prompt = f"""–¢—ã ‚Äî –ú–∏—à—É—Ä–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ–¥–µ–∂–¥—ã –Ω–∞ —Ñ–æ—Ç–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–ü–æ–≤–æ–¥/—Å–∏—Ç—É–∞—Ü–∏—è:** {occasion}
{f'- **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {preferences}' if preferences and preferences.strip() else '- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –Ω–µ —É–∫–∞–∑–∞–Ω—ã.'}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1.  **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–µ—â—å:** –î–∞–π —á–µ—Ç–∫–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –Ω–∏–∂–µ. –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω, –Ω–æ –Ω–µ —É–ø—É—Å–∫–∞–π –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.
2.  **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ):** –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞, –µ—Å–ª–∏ —Ç—ã –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–¥–∏—à—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∫—É—Ä—Å–∞ —Ñ–æ—Ç–æ, —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É, –µ—Å–ª–∏ –æ–Ω —Å–æ–≤—Å–µ–º –Ω–µ —è—Å–µ–Ω, –∏–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö –ª–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è —Å–æ–≤–µ—Ç–∞ –ø–æ –¥–∞–Ω–Ω–æ–π –≤–µ—â–∏ –∏ –ø–æ–≤–æ–¥—É) –º–æ–≥–ª–æ –±—ã *–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ* —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–π —Å–æ–≤–µ—Ç –≤ *–±—É–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ*, –¥–æ–±–∞–≤—å —Ç–∞–∫—Ç–∏—á–Ω—É—é –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π".
    * **–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫:** "–ö—Å—Ç–∞—Ç–∏, –Ω–∞ —Ñ–æ—Ç–æ –Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞ —Ç–∫–∞–Ω–∏ –ø–∏–¥–∂–∞–∫–∞. –ï—Å–ª–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ –∫—Ä—É–ø–Ω–µ–µ –∏–ª–∏ –ø—Ä–∏ –ª—É—á—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏, —è —Å–º–æ–≥—É —Ç–æ—á–Ω–µ–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫ –Ω–µ–º—É –±—Ä—é–∫–∏ –ø–æ —Ñ–∞–∫—Ç—É—Ä–µ.", "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –ø–ª–∞—Ç—å—è! –ß—Ç–æ–±—ã —è –º–æ–≥–ª–∞ –¥–∞–≤–∞—Ç—å –µ—â–µ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–∞—Å–æ–Ω–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç –≤–∞—à—É —Ñ–∏–≥—É—Ä—É, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—ã –º–æ–≥–ª–∏ –±—ã —É–ø–æ–º—è–Ω—É—Ç—å –≤–∞—à —Ä–æ—Å—Ç –∏ —Ç–∏–ø —Ñ–∏–≥—É—Ä—ã, –µ—Å–ª–∏ –≤–∞–º –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ."
    * **–ö–æ–≥–¥–∞ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É:** –ù–µ –¥–æ–±–∞–≤–ª—è–π —ç—Ç—É —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Å–æ–≤–µ—Ç–∞, –∏–ª–∏ –µ—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –±—É–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –æ–±—â–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"), –∏–ª–∏ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –¢–≤–æ—è —Ü–µ–ª—å ‚Äì –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∞ –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –ø—Ä–∏–¥–∏—Ä—á–∏–≤–æ–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (Markdown):

### 1. –û–ø–∏—Å–∞–Ω–∏–µ –í–µ—â–∏ (–ú–∏—à—É—Ä–∞)
* **–¢–∏–ø:** (–Ω–∞–ø—Ä., –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –±–ª—É–∑–∫–∞, –ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–∂–∏–Ω—Å—ã, –í–µ—á–µ—Ä–Ω–µ–µ –ø–∞–ª—å—Ç–æ)
* **–§–∞—Å–æ–Ω –∏ –∫—Ä–æ–π:** (–Ω–∞–ø—Ä., –ü–æ–ª—É–ø—Ä–∏–ª–µ–≥–∞—é—â–∏–π —Å–∏–ª—É—ç—Ç, –ü—Ä—è–º–æ–π –∫—Ä–æ–π —Å–æ —Å—Ç—Ä–µ–ª–∫–∞–º–∏, –û–≤–µ—Ä—Å–∞–π–∑ —Å –æ–±—ä–µ–º–Ω—ã–º–∏ —Ä—É–∫–∞–≤–∞–º–∏)
* **–¶–≤–µ—Ç/–ü—Ä–∏–Ω—Ç:** (–Ω–∞–ø—Ä., –ì–ª—É–±–æ–∫–∏–π –∏–∑—É–º—Ä—É–¥–Ω—ã–π, –î–µ–ª–∏–∫–∞—Ç–Ω—ã–π —Ü–≤–µ—Ç–æ—á–Ω—ã–π –ø—Ä–∏–Ω—Ç –Ω–∞ –∫—Ä–µ–º–æ–≤–æ–º —Ñ–æ–Ω–µ)
* **–ú–∞—Ç–µ—Ä–∏–∞–ª (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ):** (–Ω–∞–ø—Ä., –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —à–µ–ª–∫, –ü–ª–æ—Ç–Ω—ã–π —Ö–ª–æ–ø–æ–∫, –°–º–µ—Å–æ–≤–∞—è —à–µ—Ä—Å—Ç—å). *–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω, —É–∫–∞–∂–∏: "–ü–æ —Ñ–æ—Ç–æ —Å–ª–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª, –Ω–æ —Ç–∞–∫—Ç–∏–ª—å–Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å..."*
* **–ö–ª—é—á–µ–≤—ã–µ –¥–µ—Ç–∞–ª–∏:** (–Ω–∞–ø—Ä., –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π –≤–æ—Ä–æ—Ç–Ω–∏–∫, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –æ—Ç—Å—Ç—Ä–æ—á–∫–∞, –¥—Ä–∞–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ç–∞–ª–∏–∏)

### 2. –û—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–≤–æ–¥–∞ "{occasion}" –æ—Ç –ú–∏—à—É—Ä—ã
* **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** (–Ω–∞–ø—Ä., –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! / –û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç / –¢—Ä–µ–±—É–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ / –ù–µ —Å–∞–º—ã–π —É–¥–∞—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å...)
* **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞, –∏ –∫–∞–∫ –º–æ–∂–Ω–æ –Ω–∞–∏–ª—É—á—à–∏–º –æ–±—Ä–∞–∑–æ–º —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–≤–æ–¥–∞)

### 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –°–æ—á–µ—Ç–∞–Ω–∏—è–º –æ—Ç –ú–∏—à—É—Ä—ã (1-2 —Å–∞–º—ã—Ö —É–¥–∞—á–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞)
* **–û–±—Ä–∞–∑ 1:** (–° —á–µ–º —Å–æ—á–µ—Ç–∞—Ç—å: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–µ—Ä—Ö/–Ω–∏–∑, –æ–±—É–≤—å. –ü—Ä–∏–º–µ—Ä: "–≠—Ç–∞ —é–±–∫–∞ –±—É–¥–µ—Ç –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å—Å—è —Å –æ–±–ª–µ–≥–∞—é—â–∏–º –∫–∞—à–µ–º–∏—Ä–æ–≤—ã–º –¥–∂–µ–º–ø–µ—Ä–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –≤—ã—Å–æ–∫–∏–º–∏ —Å–∞–ø–æ–≥–∞–º–∏ –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ–º –∫–∞–±–ª—É–∫–µ –≤ —Ç–æ–Ω —é–±–∫–∏.")
* **–û–±—Ä–∞–∑ 2 (–µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ä–æ—à–∏–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç):** (–ü—Ä–∏–º–µ—Ä: "–î–ª—è –±–æ–ª–µ–µ —Å–º–µ–ª–æ–≥–æ –æ–±—Ä–∞–∑–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –µ–µ —Å –≥—Ä–∞—Ñ–∏—á–Ω–æ–π —Ñ—É—Ç–±–æ–ª–∫–æ–π, –∫–æ–∂–∞–Ω–æ–π –∫–æ—Å—É—Ö–æ–π –∏ –≥—Ä—É–±—ã–º–∏ –±–æ—Ç–∏–Ω–∫–∞–º–∏.")
* **–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã (1-2 –∫–ª—é—á–µ–≤—ã—Ö):** (–ü—Ä–∏–º–µ—Ä: "–ò–∑ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ —Å—é–¥–∞ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–æ–ª–æ—Ç—ã–µ —Å–µ—Ä—å–≥–∏.")

### 4. –û–±—â–µ–µ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –∏ –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –æ—Ç –ú–∏—à—É—Ä—ã (–∫—Ä–∞—Ç–∫–æ)
* (–ü—Ä–∏–º–µ—Ä: "–û—á–µ–Ω—å —Å—Ç–∏–ª—å–Ω–∞—è –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—â—å, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–æ–π –º–Ω–æ–≥–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ–π –æ—Å–µ–Ω–∏ –∏ –≤–µ—Å–Ω—ã.")

---
(–ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ï—Å–ª–∏ –ú–∏—à—É—Ä–∞ —Ä–µ—à–∏–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å, –Ω–∞—á–∏–Ω–∞—è —Å "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π:")
"""
    return prompt

def create_comparison_prompt(occasion, preferences=None):
    logger.debug(f"–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –ü–æ–≤–æ–¥: {occasion}, –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {preferences}")
    prompt = f"""–¢—ã ‚Äî –ú–∏—à—É—Ä–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-—Å—Ç–∏–ª–∏—Å—Ç. –¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ñ–æ—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –æ–¥–µ–∂–¥—ã. –ü—Ä–æ–≤–µ–¥–∏ –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ –µ–º–∫–∏–π —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é, –∫–∞–∫–æ–π –∏–∑ –Ω–∏—Ö –ª—É—á—à–µ.

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–ü–æ–≤–æ–¥/—Å–∏—Ç—É–∞—Ü–∏—è:** {occasion}
{f'- **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {preferences}' if preferences and preferences.strip() else '- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –Ω–µ —É–∫–∞–∑–∞–Ω—ã.'}

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1.  **–°—Ä–∞–≤–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç—ã:** –û—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –∫–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç (1-2 –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏). –ó–∞—Ç–µ–º —Å—Ä–∞–≤–Ω–∏ –∏—Ö –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–≤–æ–¥—É –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º.
2.  **–î–∞–π —á–µ—Ç–∫—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é:** –ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –ª—É—á—à–∏–º –≤—ã–±–æ—Ä–æ–º –∏ –ø–æ—á–µ–º—É (1-2 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞).
3.  **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ):** –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞, –µ—Å–ª–∏ —Ç—ã –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–¥–∏—à—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π* –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã—Ö –≤–µ—â–∞—Ö –∏–ª–∏ –æ –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–≥–ª–æ –±—ã *–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ* —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–π —Å–æ–≤–µ—Ç –≤ *–±—É–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ*, –¥–æ–±–∞–≤—å —Ç–∞–∫—Ç–∏—á–Ω—É—é –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π".
    * **–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫:** "–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑, –µ—Å–ª–∏ –±—É–¥–µ—Ç–µ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –ø–ª–∞—Ç—å—è, —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç –ø–æ–º–æ–≥—É—Ç –º–Ω–µ –ª—É—á—à–µ –æ—Ü–µ–Ω–∏—Ç—å, –∫–∞–∫ –æ–Ω–∏ —Å–∏–¥—è—Ç –ø–æ —Ñ–∏–≥—É—Ä–µ.", "–ü–æ—Å–∫–æ–ª—å–∫—É –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∫–∞–∂—É—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–º–∏, —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –∫–∞–∫–æ–π —Å—Ç–∏–ª—å (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –∏–ª–∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π) –≤–∞–º –±–ª–∏–∂–µ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –ø–æ–º–æ–≥–ª–æ –±—ã –º–Ω–µ –¥–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é."
    * **–ö–æ–≥–¥–∞ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É:** –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –±—É–¥–µ—Ç –æ–±—â–µ–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (Markdown):

### –ö—Ä–∞—Ç–∫–∏–π –û–±–∑–æ—Ä –ü—Ä–µ–¥–º–µ—Ç–æ–≤ –æ—Ç –ú–∏—à—É—Ä—ã
(–ù—É–º–µ—Ä—É–π –ø—Ä–µ–¥–º–µ—Ç—ã –∫–∞–∫ "–ü—Ä–µ–¥–º–µ—Ç 1", "–ü—Ä–µ–¥–º–µ—Ç 2" –∏ —Ç.–¥.)
* **–ü—Ä–µ–¥–º–µ—Ç 1:** (–Ω–∞–ø—Ä., –ß–µ—Ä–Ω–æ–µ –ø–ª–∞—Ç—å–µ-—Ñ—É—Ç–ª—è—Ä –∏–∑ –ø–ª–æ—Ç–Ω–æ–≥–æ —Ç—Ä–∏–∫–æ—Ç–∞–∂–∞)
* **–ü—Ä–µ–¥–º–µ—Ç 2:** (–Ω–∞–ø—Ä., –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π –±—Ä—é—á–Ω—ã–π –∫–æ—Å—Ç—é–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∫—Ä–æ—è)
    (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤–æ–¥–∞ "{occasion}" –æ—Ç –ú–∏—à—É—Ä—ã
(–û—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ, –ø–æ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç: –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–≤–æ–¥–∞)
* **–ü—Ä–µ–¥–º–µ—Ç 1:** (–Ω–∞–ø—Ä., –í—ã–≥–ª—è–¥–∏—Ç –±–æ–ª–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏ —Å—Ç—Ä–æ–≥–æ, —á—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –¥–µ–ª–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏.)
* **–ü—Ä–µ–¥–º–µ—Ç 2:** (–Ω–∞–ø—Ä., –°–æ–∑–¥–∞–µ—Ç –±–æ–ª–µ–µ —è—Ä–∫–∏–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π—Å—è –æ–±—Ä–∞–∑, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —É–º–µ—Å—Ç–µ–Ω –≤ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ.)
    (–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ)

### –ò—Ç–æ–≥–æ–≤–∞—è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç –ú–∏—à—É—Ä—ã
* **–õ—É—á—à–∏–π –≤—ã–±–æ—Ä:** –ü—Ä–µ–¥–º–µ—Ç [–ù–æ–º–µ—Ä] - –ø–æ—Ç–æ–º—É —á—Ç–æ [1-2 –≥–ª–∞–≤–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞, –ø–æ—á–µ–º—É –æ–Ω –ª—É—á—à–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–≤–æ–¥–∞, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å].
* **–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ª—É—á—à–µ–≥–æ –≤—ã–±–æ—Ä–∞ (1 —Å–æ–≤–µ—Ç):** (–Ω–∞–ø—Ä., "–î–æ–ø–æ–ª–Ω–∏—Ç–µ –ü—Ä–µ–¥–º–µ—Ç X –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º–∏ –ª–æ–¥–æ—á–∫–∞–º–∏ –∏ –Ω–µ–±–æ–ª—å—à–æ–π —Å—É–º–∫–æ–π-—Ç–æ—É—Ç.")

---
(–ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ï—Å–ª–∏ –ú–∏—à—É—Ä–∞ —Ä–µ—à–∏–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É, –æ–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å, –Ω–∞—á–∏–Ω–∞—è —Å "üí° –°–æ–≤–µ—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π:")
"""
    return prompt

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ (–ª–æ–≥–∏–∫–∞ –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
async def _send_to_gemini_with_retries(parts: list, context_for_log: str):
    logger.debug(f"_send_to_gemini_with_retries: –°—Ç–∞—Ä—Ç –¥–ª—è ({context_for_log}). –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ parts: {len(parts)}")
    if not API_CONFIGURED_SUCCESSFULLY:
        msg = f"Gemini API –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø—Ä–æ—Å ({context_for_log}) –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."
        logger.error(msg)
        return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_INTERNAL"), context_for_log)

    retry_count = 0
    last_error = None
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å –∏—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
    generation_config = genai.types.GenerationConfig(temperature=0.65) # –ù–µ–º–Ω–æ–≥–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
    safety_settings = [
        {"category": c, "threshold": "BLOCK_MEDIUM_AND_ABOVE"}
        for c in ["HARM_CATEGORY_HARASSMENT", "HARM_CATEGORY_HATE_SPEECH",
                  "HARM_CATEGORY_SEXUALLY_EXPLICIT", "HARM_CATEGORY_DANGEROUS_CONTENT"]
    ]

    while retry_count < MAX_RETRIES:
        try:
            model = genai.GenerativeModel(VISION_MODEL)
            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}/{MAX_RETRIES}...")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
            response = await model.generate_content_async(
                parts,
                generation_config=generation_config,
                safety_settings=safety_settings
            )
            
            full_response_text = ""
            # Gemini 1.5 –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ response.text –∏–ª–∏ response.parts
            if hasattr(response, 'text') and response.text:
                full_response_text = response.text
            elif response.parts:
                 full_response_text = "".join(part.text for part in response.parts if hasattr(part, 'text'))

            if full_response_text.strip(): # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤
                logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç Gemini ({context_for_log}) —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}). –î–ª–∏–Ω–∞: {len(full_response_text)}")
                return full_response_text
            else:
                # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏—á–∏–Ω—É
                finish_reason_str = "N/A"
                candidate_exists = response.candidates and len(response.candidates) > 0
                if candidate_exists and response.candidates[0].finish_reason:
                    finish_reason_str = response.candidates[0].finish_reason.name
                logger.warning(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}. –ü—Ä–∏—á–∏–Ω–∞: {finish_reason_str if candidate_exists else '–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–ª–∏ –ø—Ä–∏—á–∏–Ω—ã'}.")
                last_error = ValueError(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini. –ü—Ä–∏—á–∏–Ω–∞: {finish_reason_str}")
                setattr(last_error, 'response', response) # –î–æ–±–∞–≤–ª—è–µ–º response –∫ –æ—à–∏–±–∫–µ
                if finish_reason_str in ["SAFETY", "RECITATION", "MAX_TOKENS"]: # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è —ç—Ç–∏—Ö –ø—Ä–∏—á–∏–Ω
                    return handle_gemini_error(last_error, context_for_log)
                # –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–∏—á–∏–Ω –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑

        except Exception as e:
            last_error = e
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini ({context_for_log}), –ø–æ–ø—ã—Ç–∫–∞ {retry_count + 1}/{MAX_RETRIES}: {type(e).__name__} - {e}", exc_info=False)
            if isinstance(e, (genai.types.PermissionDeniedError, genai.types.UnauthenticatedError)):
                logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Gemini API ({context_for_log}). –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫.")
                return handle_gemini_error(e, context_for_log) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, –Ω–µ —Ä–µ—Ç—Ä–∞–∏–º

        retry_count += 1
        if retry_count < MAX_RETRIES:
            logger.info(f"–û–∂–∏–¥–∞–Ω–∏–µ {RETRY_DELAY} —Å–µ–∫. –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π ({context_for_log})...")
            await asyncio.sleep(RETRY_DELAY) # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

    logger.error(f"–í—Å–µ {MAX_RETRIES} –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ ({context_for_log}) –∫ Gemini –Ω–µ —É–¥–∞–ª–∏—Å—å. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}", exc_info=True if last_error else False)
    return handle_gemini_error(last_error or ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫."), context_for_log)


async def analyze_clothing_image(image_data: bytes, occasion: str, preferences: str = None):
    logger.info(f"analyze_clothing_image: –°—Ç–∞—Ä—Ç. –ü–æ–≤–æ–¥: {occasion}, —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {len(image_data)/1024:.1f} KB")
    if not API_CONFIGURED_SUCCESSFULLY: return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_ANALYZE"), "–æ–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑")

    if CACHE_ENABLED:
        cached_result = cache_manager.get_from_cache(image_data, occasion, preferences)
        if cached_result:
            logger.info("–†–µ–∑—É–ª—å—Ç–∞—Ç (–æ–¥–∏–Ω–æ—á–Ω—ã–π) –∏–∑ –∫—ç—à–∞.")
            return cached_result
    try:
        # –í –≤–µ—Ä—Å–∏–∏ 0.3.1 optimize_image –ø—Ä–∏–Ω–∏–º–∞–µ—Ç PIL.Image, –∞ –Ω–µ bytes/BytesIO
        pil_image = Image.open(BytesIO(image_data)) # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º bytes –≤ PIL.Image
        logger.debug("PIL.Image —Å–æ–∑–¥–∞–Ω –∏–∑ –±–∞–π—Ç –¥–ª—è optimize_image.")
        optimized_image_bytes = optimize_image(pil_image, quality=85) # quality –∫–∞–∫ –≤ –≤–∞—à–µ–π 0.3.1
    except ValueError as ve: # –û—à–∏–±–∫–∞ –æ—Ç optimize_image
        logger.error(f"analyze_clothing_image: –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ - {ve}", exc_info=True)
        return str(ve)
    except Exception as e_opt:
        logger.error(f"analyze_clothing_image: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ - {e_opt}", exc_info=True)
        return f"–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ö–æ–¥: G-OPT01)."

    prompt = create_analysis_prompt(occasion, preferences)
    parts = [prompt, {"mime_type": "image/jpeg", "data": optimized_image_bytes}]
    
    response_text = await _send_to_gemini_with_retries(parts, "–æ–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑")

    if CACHE_ENABLED and not _is_error_message(response_text): # _is_error_message –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
        cache_manager.save_to_cache(image_data, occasion, response_text, preferences) # –ö—ç—à–∏—Ä—É–µ–º –ø–æ –∏—Å—Ö–æ–¥–Ω—ã–º –±–∞–π—Ç–∞–º
        logger.info("–†–µ–∑—É–ª—å—Ç–∞—Ç (–æ–¥–∏–Ω–æ—á–Ω—ã–π) —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫—ç—à.")
    return response_text


async def compare_clothing_images(image_data_list: list[bytes], occasion: str, preferences: str = None):
    logger.info(f"compare_clothing_images: –°—Ç–∞—Ä—Ç. {len(image_data_list)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–æ–≤–æ–¥: {occasion}")
    if not API_CONFIGURED_SUCCESSFULLY: return handle_gemini_error(RuntimeError("API_NOT_CONFIGURED_COMPARE"), "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ")
    if not (2 <= len(image_data_list) <= 5):
        logger.warning(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: {len(image_data_list)}")
        return "–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç 2 –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."

    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏
    if CACHE_ENABLED: logger.debug("compare_clothing_images: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.")

    processed_parts = [create_comparison_prompt(occasion, preferences)]
    for i, img_data_bytes in enumerate(image_data_list):
        logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1} –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—Ä–∞–∑–º–µ—Ä: {len(img_data_bytes)/1024:.1f} KB).")
        try:
            pil_image = Image.open(BytesIO(img_data_bytes)) # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º bytes –≤ PIL.Image
            logger.debug(f"PIL.Image {i+1} —Å–æ–∑–¥–∞–Ω –¥–ª—è optimize_image.")
            optimized_bytes = optimize_image(pil_image, quality=85)
            processed_parts.append({"mime_type": "image/jpeg", "data": optimized_bytes})
        except ValueError as ve:
            logger.error(f"compare_clothing_images: –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1} - {ve}", exc_info=True)
            return str(ve)
        except Exception as e_opt:
            logger.error(f"compare_clothing_images: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ {i+1} - {e_opt}", exc_info=True)
            return f"–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1} –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–ö–æ–¥: G-OPT02)."
            
    return await _send_to_gemini_with_retries(processed_parts, "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ")

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –æ—à–∏–±–∫–æ–π (–Ω—É–∂–Ω–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
def _is_error_message(text: str) -> bool:
    if not text: return True
    keywords = ["–æ—à–∏–±–∫–∞:", "–Ω–µ –Ω–∞–π–¥–µ–Ω", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π", "–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª",
                "–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "–ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç–µ–≤—ã–º", "–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞",
                "(–∫–æ–¥: g", "–Ω–µ —É–¥–∞–ª–æ—Å—å"]
    text_lower = text.lower()
    return any(keyword in text_lower for keyword in keywords)


async def analyze_clothing_file(file_path, occasion, preferences=None):
    # (–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1, –æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –µ—Å–ª–∏ analyze_clothing_image –æ–∂–∏–¥–∞–µ—Ç bytes)
    logger.info(f"–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: {file_path}")
    if not os.path.exists(file_path):
        logger.error(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
        return "–û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    try:
        with open(file_path, "rb") as image_file:
            image_data = image_file.read() # –ß–∏—Ç–∞–µ–º –±–∞–π—Ç—ã
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}", exc_info=True)
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {str(e)}"
    return await analyze_clothing_image(image_data, occasion, preferences)


if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –∏–∑ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ 0.3.1, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
    # –∏ –≤—ã–∑–æ–≤–∞ –Ω–æ–≤—ã—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π _send_to_gemini_with_retries
    # –û–Ω —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BytesIO –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ analyze_clothing_image
    async def main_test():
        print(f"–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è Gemini AI –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ú–ò–®–£–†–ê (v0.3.1.1)... –ö—ç—à {'–í–ö–õ–Æ–ß–ï–ù' if CACHE_ENABLED else '–û–¢–ö–õ–Æ–ß–ï–ù'}.")
        if not API_CONFIGURED_SUCCESSFULLY:
            print("–û–®–ò–ë–ö–ê: Gemini API –Ω–µ –±—ã–ª —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.")
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–≤—ã–∑—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é)
        connected, msg = await test_gemini_connection()
        print(f"–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini: {'–£–°–ü–ï–®–ù–û' if connected else '–û–®–ò–ë–ö–ê'} - {msg}")
        if not connected:
            return

        img_data_cache_test = {}
        def get_test_image_bytes(color_name: str, text_on_img: str, rgb_tuple: tuple, quality: int = 75, size: tuple = (300,400)) -> bytes:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PIL Image, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ BytesIO, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç bytes
            cache_key = f"{color_name}_{quality}_{size[0]}x{size[1]}"
            if cache_key in img_data_cache_test:
                # logger.debug(f"Using cached test image bytes: {cache_key}")
                return img_data_cache_test[cache_key]

            img = Image.new('RGB', size, color=rgb_tuple)
            draw = ImageDraw.Draw(img)
            try:
                from PIL import ImageFont
                font_size = int(size[1] / 10)
                try: font = ImageFont.truetype("arial.ttf", font_size)
                except IOError:
                    try: font = ImageFont.truetype("DejaVuSans.ttf", font_size)
                    except IOError: font = ImageFont.load_default() # Fallback
                # –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                # text_bbox = draw.textbbox((0,0), text_on_img, font=font)
                # text_width = text_bbox[2] - text_bbox[0]
                # text_height = text_bbox[3] - text_bbox[1]
                # x = (img.width - text_width) / 2
                # y = (img.height - text_height) / 2
                # draw.text((x, y), text_on_img, fill="white", font=font)
                draw.text((img.width*0.1, img.height*0.45), text_on_img, fill="white") # –£–ø—Ä–æ—â–µ–Ω–Ω–æ
            except Exception as font_e:
                logger.warning(f"–û—à–∏–±–∫–∞ —à—Ä–∏—Ñ—Ç–∞ –≤ —Ç–µ—Å—Ç–µ: {font_e}. –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç.")
                draw.text((img.width*0.1, img.height*0.45), text_on_img, fill="white")

            img_bytes_io = BytesIO()
            img.save(img_bytes_io, format='JPEG', quality=quality)
            img_bytes = img_bytes_io.getvalue()
            img_data_cache_test[cache_key] = img_bytes
            # logger.debug(f"Created test image bytes: {cache_key}, size: {len(img_bytes)/1024:.1f} KB")
            return img_bytes

        try:
            print("\n--- –¢–µ—Å—Ç 1: –û–¥–∏–Ω–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–ö—Ä–∞—Å–Ω–æ–µ –ø–ª–∞—Ç—å–µ) ---")
            red_dress_bytes = get_test_image_bytes("red_dress", "–ö—Ä–∞—Å–Ω–æ–µ –ü–ª–∞—Ç—å–µ", (200,20,20))
            advice_single = await analyze_clothing_image(
                red_dress_bytes,
                "–∫–æ–∫—Ç–µ–π–ª—å–Ω–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞",
                "–ª—é–±–ª—é —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å, –∏–∑–±–µ–≥–∞—é —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–≥–æ"
            )
            print("\n–û—Ç–≤–µ—Ç –ú–∏—à—É—Ä—ã (–æ–¥–∏–Ω–æ—á–Ω—ã–π):")
            print(advice_single)

            print("\n--- –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–ö—Ä–∞—Å–Ω–æ–µ –ø–ª–∞—Ç—å–µ –∏ –°–∏–Ω–∏–µ –¥–∂–∏–Ω—Å—ã) ---")
            blue_jeans_bytes = get_test_image_bytes("blue_jeans_comp", "–°–∏–Ω–∏–µ –î–∂–∏–Ω—Å—ã", (20,20,180))
            advice_compare = await compare_clothing_images(
                [red_dress_bytes, blue_jeans_bytes],
                "–ø–æ—Ö–æ–¥ –≤ –∫–∏–Ω–æ —Å –¥—Ä—É–∑—å—è–º–∏",
                "—É–¥–æ–±—Å—Ç–≤–æ –∏ —Å—Ç–∏–ª—å"
            )
            print("\n–û—Ç–≤–µ—Ç –ú–∏—à—É—Ä—ã (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ):")
            print(advice_compare)

        except Exception as e:
            print(f"\n–û–®–ò–ë–ö–ê –í–û –í–†–ï–ú–Ø –ì–õ–ê–í–ù–û–ì–û –¢–ï–°–¢–ê: {type(e).__name__} - {e}")
            import traceback
            traceback.print_exc()

    asyncio.run(main_test())