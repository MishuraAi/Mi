/*
==========================================================================================
ÐŸÐ ÐžÐ•ÐšÐ¢: ÐœÐ˜Ð¨Ð£Ð Ð - Ð’Ð°Ñˆ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð˜Ð˜-Ð¡Ñ‚Ð¸Ð»Ð¸ÑÑ‚
ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢: Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (app.js)
Ð’Ð•Ð Ð¡Ð˜Ð¯: 0.5.1 (Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹)
Ð”ÐÐ¢Ð ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯: 2025-05-26

ÐÐÐ—ÐÐÐ§Ð•ÐÐ˜Ð• Ð¤ÐÐ™Ð›Ð:
Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽÑ‰Ð¸Ð¹ Ð·Ð° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð¸ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ†Ð¸ÑŽ Ð¸Ñ… Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.
==========================================================================================
*/

window.MishuraApp = window.MishuraApp || {};

window.MishuraApp.app = (function() {
    'use strict';
    
    let logger;
    let uiHelpers;
    let apiService;
    let modals;
    let consultation;
    let comparison;
    let imageUpload;
    let isAppInitialized = false;
    
    function init() {
        if (isAppInitialized) {
            console.warn('App ÑƒÐ¶Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½ÑƒÑŽ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ');
            return;
        }

        console.log('ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÐœÐ˜Ð¨Ð£Ð Ð');
        
        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ
        initializeLogger();
        initializeUIHelpers();
        initializeAPIService();
        initializeModals();
        initializeImageUpload();
        initializeConsultation();
        initializeComparison();
        
        // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ ÐŸÐžÐ¡Ð›Ð• Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
        setTimeout(() => {
            setupEventHandlers();
            setupNavigation();
        }, 100);
        
        isAppInitialized = true;
        logger.info('Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
    }
    
    function initializeLogger() {
        if (window.MishuraApp.utils && window.MishuraApp.utils.logger) {
            logger = window.MishuraApp.utils.logger;
            if (typeof logger.init === 'function') {
                logger.init();
            }
        } else {
            logger = console;
            console.warn('Logger Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ console');
        }
    }
    
    function initializeUIHelpers() {
        if (window.MishuraApp.utils && window.MishuraApp.utils.uiHelpers) {
            uiHelpers = window.MishuraApp.utils.uiHelpers;
            if (typeof uiHelpers.init === 'function') {
                uiHelpers.init();
            }
            logger.debug('UI Helpers Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹');
        } else {
            logger.error('UI Helpers Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹');
        }
    }
    
    function initializeAPIService() {
        if (window.MishuraApp.utils && window.MishuraApp.utils.api) {
            apiService = window.MishuraApp.utils.api;
            if (typeof apiService.init === 'function') {
                apiService.init();
            }
            logger.debug('API Service Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
        } else {
            logger.error('API Service Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
        }
    }
    
    function initializeModals() {
        if (window.MishuraApp.components && window.MishuraApp.components.modals) {
            modals = window.MishuraApp.components.modals;
            if (typeof modals.init === 'function') {
                modals.init();
            }
            logger.debug('Modals Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹');
        } else {
            logger.error('Modals Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹');
        }
    }
    
    function initializeImageUpload() {
        if (window.MishuraApp.components && window.MishuraApp.components.imageUpload) {
            imageUpload = window.MishuraApp.components.imageUpload;
            if (typeof imageUpload.init === 'function') {
                imageUpload.init();
            }
            logger.debug('Image Upload Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
        } else {
            logger.error('Image Upload Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
        }
    }
    
    function initializeConsultation() {
        if (window.MishuraApp.features && window.MishuraApp.features.consultation) {
            consultation = window.MishuraApp.features.consultation;
            if (typeof consultation.init === 'function') {
                consultation.init();
            }
            logger.debug('Consultation Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
        } else {
            logger.error('Consultation Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
        }
    }
    
    function initializeComparison() {
        if (window.MishuraApp.features && window.MishuraApp.features.comparison) {
            comparison = window.MishuraApp.features.comparison;
            if (typeof comparison.init === 'function') {
                comparison.init();
            }
            logger.debug('Comparison Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
        } else {
            logger.error('Comparison Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
        }
    }
    
    function setModalMode(mode) {
        logger.debug(`Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°: ${mode}`);
        
        const singleMode = document.getElementById('single-analysis-mode');
        const compareMode = document.getElementById('compare-analysis-mode');
        const dialogTitle = document.getElementById('consultation-dialog-title');
        const dialogSubtitle = document.querySelector('#consultation-overlay .dialog-subtitle');
        
        if (mode === 'single') {
            if (singleMode) singleMode.classList.remove('hidden');
            if (compareMode) compareMode.classList.add('hidden');
            if (dialogTitle) dialogTitle.textContent = 'ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸ÑŽ';
            if (dialogSubtitle) dialogSubtitle.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¾Ð´ÐµÐ¶Ð´Ñ‹ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°';
        } else if (mode === 'compare') {
            if (singleMode) singleMode.classList.add('hidden');
            if (compareMode) compareMode.classList.remove('hidden');
            if (dialogTitle) dialogTitle.textContent = 'Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ñ‹';
            if (dialogSubtitle) dialogSubtitle.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¾Ñ‚ 2 Ð´Ð¾ 4 Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¹ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ';
        }
        
        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
        document.dispatchEvent(new CustomEvent('modeChanged', { detail: { mode: mode } }));
        logger.debug(`Ð ÐµÐ¶Ð¸Ð¼ ${mode} ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾`);
    }
    
    function setupEventHandlers() {
        logger.debug('ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹');
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ (Ñ€ÐµÐ¶Ð¸Ð¼ single)
        const consultationButton = document.getElementById('consultation-button');
        if (consultationButton) {
            consultationButton.addEventListener('click', function(e) {
                e.preventDefault();
                logger.debug('ÐÐ°Ð¶Ð°Ñ‚Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ (single mode)');
                if (consultation && typeof consultation.openConsultationModal === 'function') {
                    consultation.openConsultationModal();
                    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ¶Ð¸Ð¼ single Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹
                    setTimeout(() => setModalMode('single'), 50);
                } else {
                    logger.error('Consultation module Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
                }
            });
            
            logger.debug('ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½');
        } else {
            logger.warn('ÐšÐ½Ð¾Ð¿ÐºÐ° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ð¾ ID');
        }
        
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (Ñ€ÐµÐ¶Ð¸Ð¼ compare)
        const compareButton = document.getElementById('compare-button');
        if (compareButton) {
            compareButton.addEventListener('click', function(e) {
                e.preventDefault();
                logger.debug('ÐÐ°Ð¶Ð°Ñ‚Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (compare mode)');
                if (consultation && typeof consultation.openConsultationModal === 'function') {
                    consultation.openConsultationModal();
                    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ¶Ð¸Ð¼ compare Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹
                    setTimeout(() => setModalMode('compare'), 50);
                } else {
                    logger.error('Consultation module Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
                }
            });
            
            logger.debug('ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½');
        } else {
            logger.warn('ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ð¾ ID');
        }
    }
    
    function setupNavigation() {
        logger.debug('ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸');
        
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                logger.debug(`ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ: ${page}`);
                
                // Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ ÑÐµÐºÑ†Ð¸Ð¸
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ ÑÐµÐºÑ†Ð¸ÑŽ
                const targetSection = document.getElementById(`${page}-section`);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                } else {
                    // Ð•ÑÐ»Ð¸ ÑÐµÐºÑ†Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ
                    const homeSection = document.getElementById('home-section');
                    if (homeSection) {
                        homeSection.classList.remove('hidden');
                    }
                    logger.warn(`Ð¡ÐµÐºÑ†Ð¸Ñ ${page}-section Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°`);
                }
                
                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸
                document.querySelectorAll('.nav-item').forEach(navItem => navItem.classList.remove('active'));
                this.classList.add('active');
                
                // Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð²Ð¸Ð´Ð½Ð°
                const navBar = document.querySelector('.nav-bar');
                if (navBar) {
                    navBar.style.display = 'flex';
                    navBar.style.visibility = 'visible';
                }

                // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð¾ ÑÐ¼ÐµÐ½Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
                document.dispatchEvent(new CustomEvent('navigationChanged', { 
                    detail: { page: page } 
                }));
            });
        });
        
        logger.debug('ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°');
    }
    
    function showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('active');
        }
    }
    
    function activateLuxuryBlocks() {
        document.querySelectorAll('.tip-card, .history-item, .balance-card, .results-container').forEach(el => {
            if (!el.classList.contains('active')) {
                setTimeout(() => el.classList.add('active'), 100);
            }
        });
    }
    
    return {
        init,
        setModalMode,
        activateLuxuryBlocks
    };
})();

window.addEventListener('DOMContentLoaded', () => {
    if (window.MishuraApp && window.MishuraApp.app && typeof window.MishuraApp.app.activateLuxuryBlocks === 'function') {
        window.MishuraApp.app.activateLuxuryBlocks();
    }
});